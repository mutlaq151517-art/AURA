<script>
const API_BASE="https://aura-backend-mpvi.onrender.com";
const API=API_BASE+"/movies";
let allSeries=[];

async function loadSeries(){
  try{
    const res = await fetch(API);

    if(!res.ok){
      throw new Error("Server not responding");
    }

    const data = await res.json();

    if(!Array.isArray(data)){
      throw new Error("Invalid data");
    }

    allSeries = data;
    renderSeries(data);

  }catch(err){
    console.error("LOAD ERROR:", err);
    document.getElementById("seriesRow").innerHTML =
      "<p style='padding:20px'>âš ï¸ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØªØ£Ø®Ø± Ø­Ø§Ù„ÙŠØ§Ù‹... Ø­Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ Ø«ÙˆØ§Ù†ÙŠ</p>";
  }
}

function renderSeries(data){
  const row=document.getElementById("seriesRow");
  row.innerHTML="";
  data.forEach(item=>{
    row.innerHTML+=`
      <div class="card" onclick="openSeries('${item._id}')">
        <img src="${item.image}">
      </div>`;
  });
}

function openSeries(id){
  const series=allSeries.find(s=>s._id===id);
  if(!series) return;

  const overlay=document.createElement("div");
  overlay.className="overlay";

  overlay.innerHTML=`
    <h2 style="text-align:center;text-shadow:0 0 20px #00bfff;">
      ${series.title}
    </h2>

    <div class="episodes-grid">
      ${
        series.episodes && series.episodes.length
        ? series.episodes.map((ep,index)=>`
            <div class="episode-card" 
                 onclick="handlePlay('${series._id}', ${index})">
              <img src="${ep.image || series.image}">
              <div class="episode-number">Ø§Ù„Ø­Ù„Ù‚Ø© ${index+1}</div>
              <div class="play-badge">
                ${index < 2 ? "â–¶ Ù…Ø¬Ø§Ù†ÙŠ" : "ğŸ”’ Ø§Ø´ØªØ±Ø§Ùƒ"}
              </div>
            </div>
          `).join("")
        : ""
      }
    </div>

    <div style="text-align:center">
      <button class="close-btn" onclick="this.closest('.overlay').remove()">
        âœ– Ø¥ØºÙ„Ø§Ù‚
      </button>
    </div>
  `;

  document.body.appendChild(overlay);
}

async function handlePlay(movieId, episodeIndex){
  const token=localStorage.getItem("token");

  if(!token){
    alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }

  try{
    const res=await fetch(
      `${API_BASE}/watch/${movieId}/${episodeIndex}`,
      {
        headers:{ Authorization: token }
      }
    );

    if(res.status===403){
      alert("Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù„Ù‚Ø© Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙ‚Ø· ğŸ”’");
      return;
    }

    if(!res.ok){
      throw new Error("Watch failed");
    }

    const data=await res.json();
    playVideo(data.video);

  }catch(err){
    alert("Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ØºÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹... Ø­Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ Ù„Ø­Ø¸Ø©");
  }
}

function playVideo(url){
  const player=document.createElement("div");
  player.className="overlay";

  player.innerHTML=`
    <div style="text-align:center">
      <video src="${url}" controls autoplay
        style="width:95%;max-width:1000px;border-radius:25px;
        box-shadow:0 0 40px rgba(0,191,255,0.9);">
      </video>
      <div style="margin-top:25px">
        <button class="close-btn" onclick="this.closest('.overlay').remove()">
          âœ– Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(player);
}

loadSeries();
</script>

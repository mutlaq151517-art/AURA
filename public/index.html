<script>
const API_BASE="https://aura-backend-mpvi.onrender.com";
const API=API_BASE+"/movies";
let allSeries=[];

async function loadSeries(){
  const res=await fetch(API);
  const data=await res.json();
  allSeries=data;
  renderSeries(data);
}

function renderSeries(data){
  const row=document.getElementById("seriesRow");
  row.innerHTML="";
  data.forEach(item=>{
    row.innerHTML+=`
      <div class="card" onclick="openSeries('${item._id}')">
        <img src="${item.image}">
      </div>`;
  });
}

function openSeries(id){
  const series=allSeries.find(s=>s._id===id);
  if(!series) return;

  const overlay=document.createElement("div");
  overlay.className="overlay";

  overlay.innerHTML=`
    <h2 style="text-align:center;text-shadow:0 0 20px #00bfff;">
      ${series.title}
    </h2>

    <div class="episodes-grid">
      ${
        series.episodes && series.episodes.length
        ? series.episodes.map((ep,index)=>`
            <div class="episode-card" 
                 onclick="handlePlay('${series._id}', ${index})">
              <img src="${ep.image || series.image}">
              <div class="episode-number">Ø§Ù„Ø­Ù„Ù‚Ø© ${index+1}</div>
              ${
                index < 2 
                ? `<div class="play-badge">â–¶ Ù…Ø¬Ø§Ù†ÙŠ</div>`
                : `<div class="play-badge">ğŸ”’ Ø§Ø´ØªØ±Ø§Ùƒ</div>`
              }
            </div>
          `).join("")
        : `
            <div class="episode-card"
                 onclick="handlePlay('${series._id}', 0)">
              <img src="${series.image}">
              <div class="episode-number">Ø§Ù„Ø­Ù„Ù‚Ø© 1</div>
              <div class="play-badge">â–¶ Ù…Ø¬Ø§Ù†ÙŠ</div>
            </div>
          `
      }
    </div>

    <div style="text-align:center">
      <button class="close-btn" onclick="this.closest('.overlay').remove()">
        âœ– Ø¥ØºÙ„Ø§Ù‚
      </button>
    </div>
  `;

  document.body.appendChild(overlay);
}

async function handlePlay(movieId, episodeIndex){
  const token=localStorage.getItem("token");

  if(!token){
    alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }

  try{
    const res=await fetch(
      `${API_BASE}/watch/${movieId}/${episodeIndex}`,
      {
        headers:{ Authorization: token }
      }
    );

    if(res.status===403){
      alert("Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù„Ù‚Ø© Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙ‚Ø· ğŸ”’");
      return;
    }

    const data=await res.json();
    playVideo(data.video);

  }catch(err){
    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„");
  }
}

function playVideo(url){
  const player=document.createElement("div");
  player.className="overlay";

  player.innerHTML=`
    <div style="text-align:center">
      <video src="${url}" controls autoplay
        style="width:95%;max-width:1000px;border-radius:25px;
        box-shadow:0 0 40px rgba(0,191,255,0.9);">
      </video>
      <div style="margin-top:25px">
        <button class="close-btn" onclick="this.closest('.overlay').remove()">
          âœ– Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(player);
}

loadSeries();
</script>
